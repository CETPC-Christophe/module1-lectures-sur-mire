<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mires Verticales avec Chiffres Positionnables</title>
<style>
  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    width: 100%;
    overflow: hidden;
    background-color: #f0f0f0;
    font-family: sans-serif;
  }

  .main-layout {
    display: flex;
    width: 100%;
    height: 100%;
  }

  .left-panel {
    flex: 1;
    position: relative;
    display: flex;
    justify-content: center;
    align-items: center;
    border-right: 1px solid #ccc;
    height: 100%;
  }

  .right-panel {
    flex: 1;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100%;
    background-color: #e0e0e0;
  }

  .mires-viewport {
    /* width: clamp(3cm, 20vw, 6cm);  <-- Supprim√©, g√©r√© par JS/Contenu */
    height: 80%; /* Ajust√© pour laisser de l'espace autour */
    max-height: 80vh;
    overflow: hidden;
    position: relative;
    border: 2px solid #333;
    background-color: white;
    /* Transition fluide de la largeur lors du zoom */
    transition: width 0.1s ease-out;
  }

  .mires-wrapper {
    display: flex;
    flex-direction: column;
    position: absolute;
    left: 0;
    gap: 0;
    cursor: grab;
    user-select: none;
    /* Largeur d√©finie ici maintenant */
    width: clamp(3cm, 20vw, 6cm);
  }

  .mires-wrapper.dragging {
    cursor: grabbing;
  }

  .mire {
    display: flex;
    flex-direction: column-reverse;
    position: relative;
    gap: 0;
    width: 100%;
  }

  .line-container {
    display: flex;
    width: 100%; /* S'adapte au wrapper */
    height: clamp(0.75cm, 5vw, 1.5cm);
  }

  .line-container.first-line {
    border-bottom: 2px solid black;
    position: relative;
    z-index: 5;
  }

  .square {
    flex: 1;
    height: 100%;
  }

  .red { background-color: red; }
  .black { background-color: black; }
  .white { background-color: white; }

  .trait-noir {
    display: none;
  }

  .chiffre {
    position: absolute;
    font-size: clamp(0.6cm, 3vw, 1.2cm);
    font-weight: bold;
    color: black;
    transform: scaleX(2) scaleY(5);
    transform-origin: left bottom;
    z-index: 10;
  }

  .chiffre.red {
    color: red;
    background-color: white;
    padding: 2px 4px;
    border-radius: 2px;
  }

  .reading-line {
    position: absolute;
    width: clamp(4.5cm, 30vw, 9cm);
    height: 2px;
    background-color: black;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 100;
  }

  .reading-line::before, .reading-line::after {
    content: '';
    position: absolute;
    top: -5px;
    width: 0; 
    height: 0; 
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
  }
  
  .reading-line::before {
    left: -10px;
    border-right: 10px solid black;
  }

  .reading-line::after {
    right: -10px;
    border-left: 10px solid black;
  }

  .reading-value {
    font-size: clamp(48px, 10vw, 96px);
    font-weight: bold;
    color: #333;
    text-align: center;
  }
  .zoom-controls {
    position: absolute;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 200;
  }

  .zoom-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: none;
    background-color: #333;
    color: white;
    font-size: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    transition: background-color 0.2s;
  }

  .zoom-btn:hover {
    background-color: #555;
  }

  .zoom-btn:active {
    background-color: #111;
  }

  .show-reading-btn {
    padding: 15px 30px;
    font-size: 24px;
    background-color: #007bff;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    display: none; /* Cach√© par d√©faut */
  }

  .show-reading-btn:hover {
    background-color: #0056b3;
  }

  .random-btn {
    margin-top: 20px;
    padding: 10px 20px;
    font-size: 18px;
    background-color: #28a745;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }

  .random-btn:hover {
    background-color: #218838;
  }
</style>
</head>
<body>

<div class="main-layout">
  <div class="left-panel">
    <div class="mires-viewport" id="miresViewport">
    <div class="mires-wrapper" id="miresWrapper">
      <!-- mire39 (39) -->
<div class="mire" id="mire39">
  <div class="trait-noir"></div>
</div>

<!-- mire38 (38) -->
<div class="mire" id="mire38">
  <div class="trait-noir"></div>
</div>

<!-- mire37 (37) -->
<div class="mire" id="mire37">
  <div class="trait-noir"></div>
</div>

<!-- mire36 (36) -->
<div class="mire" id="mire36">
  <div class="trait-noir"></div>
</div>

<!-- mire35 (35) -->
<div class="mire" id="mire35">
  <div class="trait-noir"></div>
</div>

<!-- mire34 (34) -->
<div class="mire" id="mire34">
  <div class="trait-noir"></div>
</div>

<!-- mire33 (33) -->
<div class="mire" id="mire33">
  <div class="trait-noir"></div>
</div>

<!-- mire32 (32) -->
<div class="mire" id="mire32">
  <div class="trait-noir"></div>
</div>

<!-- mire31 (31) -->
<div class="mire" id="mire31">
  <div class="trait-noir"></div>
</div>

<!-- mire30 (30) -->
<div class="mire" id="mire30">
  <div class="trait-noir"></div>
</div>

<!-- mire29 (29) -->
<div class="mire" id="mire29">
  <div class="trait-noir"></div>
</div>

<!-- mire28 (28) -->
<div class="mire" id="mire28">
  <div class="trait-noir"></div>
</div>

<!-- mire27 (27) -->
<div class="mire" id="mire27">
  <div class="trait-noir"></div>
</div>

<!-- mire26 (26) -->
<div class="mire" id="mire26">
  <div class="trait-noir"></div>
</div>

<!-- mire25 (25) -->
<div class="mire" id="mire25">
  <div class="trait-noir"></div>
</div>

<!-- mire24 (24) -->
<div class="mire" id="mire24">
  <div class="trait-noir"></div>
</div>

<!-- mire23 (23) -->
<div class="mire" id="mire23">
  <div class="trait-noir"></div>
</div>

<!-- mire22 (22) -->
<div class="mire" id="mire22">
  <div class="trait-noir"></div>
</div>

<!-- mire21 (21) -->
<div class="mire" id="mire21">
  <div class="trait-noir"></div>
</div>

<!-- mire20 (20) -->
<div class="mire" id="mire20">
  <div class="trait-noir"></div>
</div>

<!-- mire19 (19) -->
<div class="mire" id="mire19">
  <div class="trait-noir"></div>
</div>

<!-- mire18 (18) -->
<div class="mire" id="mire18">
  <div class="trait-noir"></div>
</div>

<!-- mire17 (17) -->
<div class="mire" id="mire17">
  <div class="trait-noir"></div>
</div>

<!-- mire16 (16) -->
<div class="mire" id="mire16">
  <div class="trait-noir"></div>
</div>

<!-- mire15 (15) -->
<div class="mire" id="mire15">
  <div class="trait-noir"></div>
</div>

<!-- mire14 (14) -->
<div class="mire" id="mire14">
  <div class="trait-noir"></div>
</div>

<!-- mire13 (13) -->
<div class="mire" id="mire13">
  <div class="trait-noir"></div>
</div>

<!-- mire12 (12) -->
<div class="mire" id="mire12">
  <div class="trait-noir"></div>
</div>

<!-- mire11 (11) -->
<div class="mire" id="mire11">
  <div class="trait-noir"></div>
</div>

<!-- mire10 (10) -->
<div class="mire" id="mire10">
  <div class="trait-noir"></div>
</div>

<!-- mire9 (9) -->
<div class="mire" id="mire9">
  <div class="trait-noir"></div>
</div>

<!-- mire8 (8) -->
<div class="mire" id="mire8">
  <div class="trait-noir"></div>
</div>

<!-- mire7 (7) -->
<div class="mire" id="mire7">
  <div class="trait-noir"></div>
</div>

<!-- mire6 (6) -->
<div class="mire" id="mire6">
  <div class="trait-noir"></div>
</div>

<!-- mire5 (5) -->
<div class="mire" id="mire5">
  <div class="trait-noir"></div>
</div>

<!-- mire4 (4) -->
<div class="mire" id="mire4">
  <div class="trait-noir"></div>
</div>

<!-- mire3 (3) -->
<div class="mire" id="mire3">
  <div class="trait-noir"></div>
</div>

<!-- mire2 (2) -->
<div class="mire" id="mire2">
  <div class="trait-noir"></div>
</div>

<!-- mire1 (1) -->
<div class="mire" id="mire1">
  <div class="trait-noir"></div>
</div>

<!-- mire0 (0) -->
<div class="mire" id="mire0">
  <div class="trait-noir"></div>
</div>
    </div>
  </div>
  <div class="reading-line"></div>
  <div class="zoom-controls">
    <button class="zoom-btn" onclick="zoom(-1)">-</button>
    <button class="zoom-btn" onclick="zoom(1)">+</button>
  </div>
</div>

<div class="right-panel" style="flex-direction: column;">
  <div class="reading-value" id="readingValue">0 mm</div>
  <button id="showReadingBtn" class="show-reading-btn">Voir la lecture</button>
  <button id="randomBtn" class="random-btn">Placement al√©atoire</button>
</div>
</div>

<script>
  // Couleurs des mires
  const mire1Colors = [
    ['white','white','white','white'],
    ['white','white','red','white'],
    ['white','white','white','white'],
    ['white','white','red','white'],
    ['white','white','white','white'],
    ['white','white','red','red'],
    ['white','white','white','red'],
    ['white','white','red','red'],
    ['white','white','white','red'],
    ['white','white','red','red']
  ];

  const mire2Colors = [
    ['white','white','white','white'],
    ['white','red','white','white'],
    ['white','white','white','white'],
    ['white','red','white','white'],
    ['white','white','white','white'],
    ['red','red','white','white'],
    ['red','white','white','white'],
    ['red','red','white','white'],
    ['red','white','white','white'],
    ['red','red','white','white']
  ];

  const mire1BlackColors = [
    ['white','white','white','white'],
    ['white','white','black','white'],
    ['white','white','white','white'],
    ['white','white','black','white'],
    ['white','white','white','white'],
    ['white','white','black','black'],
    ['white','white','white','black'],
    ['white','white','black','black'],
    ['white','white','white','black'],
    ['white','white','black','black']
  ];

  const mire2BlackColors = [
    ['white','white','white','white'],
    ['white','black','white','white'],
    ['white','white','white','white'],
    ['white','black','white','white'],
    ['white','white','white','white'],
    ['black','black','white','white'],
    ['black','white','white','white'],
    ['black','black','white','white'],
    ['black','white','white','white'],
    ['black','black','white','white']
  ];

  function generateMire(mireId, colors) {
    const mire = document.getElementById(mireId);
    colors.forEach((line, index) => {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'line-container';
      if (index === 0) {
        lineDiv.classList.add('first-line');
      }
      line.forEach(color => {
        const square = document.createElement('div');
        square.className = `square ${color}`;
        lineDiv.appendChild(square);
      });
      mire.appendChild(lineDiv);
    });
  }

  // G√©n√©rer les mires
  generateMire('mire10', mire1Colors);
  generateMire('mire11', mire2Colors);
  generateMire('mire12', mire1Colors);
  generateMire('mire13', mire2Colors);
  generateMire('mire14', mire1Colors);
  generateMire('mire15', mire2Colors);
  generateMire('mire16', mire1Colors);
  generateMire('mire17', mire2Colors);
  generateMire('mire18', mire1Colors);
  generateMire('mire19', mire2Colors);
  generateMire('mire20', mire1BlackColors);
  generateMire('mire21', mire2BlackColors);
  generateMire('mire22', mire1BlackColors);
  generateMire('mire23', mire2BlackColors);
  generateMire('mire24', mire1BlackColors);
  generateMire('mire25', mire2BlackColors);
  generateMire('mire26', mire1BlackColors);
  generateMire('mire27', mire2BlackColors);
  generateMire('mire28', mire1BlackColors);
  generateMire('mire29', mire2BlackColors);
  generateMire('mire30', mire1Colors);
  generateMire('mire31', mire2Colors);
  generateMire('mire32', mire1Colors);
  generateMire('mire33', mire2Colors);
  generateMire('mire34', mire1Colors);
  generateMire('mire35', mire2Colors);
  generateMire('mire36', mire1Colors);
  generateMire('mire37', mire2Colors);
  generateMire('mire38', mire1Colors);
  generateMire('mire39', mire2Colors);
  generateMire('mire9', mire2BlackColors);
  generateMire('mire8', mire1BlackColors);
  generateMire('mire7', mire2BlackColors);
  generateMire('mire6', mire1BlackColors);
  generateMire('mire5', mire2BlackColors);
  generateMire('mire4', mire1BlackColors);
  generateMire('mire3', mire2BlackColors);
  generateMire('mire2', mire1BlackColors);
  generateMire('mire1', mire2BlackColors);
  generateMire('mire0', mire1BlackColors);

  // Positions personnalis√©es des chiffres pour chaque mire
  const chiffresPositions = {
    mire0: { left: '0%', bottom: '0cm', value: '00' },
    mire1: { left: '50%', bottom: '-1mm', value: '01' },
    mire2: { left: '0%', bottom: '-1mm', value: '02' },
    mire3: { left: '50%', bottom: '-1mm', value: '03' },
    mire4: { left: '0%', bottom: '-1mm', value: '04' },
    mire5: { left: '50%', bottom: '-1mm', value: '05' },
    mire6: { left: '0%', bottom: '-1mm', value: '06' },
    mire7: { left: '50%', bottom: '-1mm', value: '07' },
    mire8: { left: '0%', bottom: '-1mm', value: '08' },
    mire9: { left: '50%', bottom: '-1mm', value: '09' },
    mire10: { left: '0%', bottom: '-1mm', value: '10' },
    mire11: { left: '50%', bottom: '-1mm', value: '11' },
    mire12: { left: '0%', bottom: '-1mm', value: '12' },
    mire13: { left: '50%', bottom: '-1mm', value: '13' },
    mire14: { left: '0%', bottom: '-1mm', value: '14' },
    mire15: { left: '50%', bottom: '-1mm', value: '15' },
    mire16: { left: '0%', bottom: '-1mm', value: '16' },
    mire17: { left: '50%', bottom: '-1mm', value: '17' },
    mire18: { left: '0%', bottom: '-1mm', value: '18' },
    mire19: { left: '50%', bottom: '-1mm', value: '19' },
    mire20: { left: '0%', bottom: '-1mm', value: '20' },
    mire21: { left: '50%', bottom: '-1mm', value: '21' },
    mire22: { left: '0%', bottom: '-1mm', value: '22' },
    mire23: { left: '50%', bottom: '-1mm', value: '23' },
    mire24: { left: '0%', bottom: '-1mm', value: '24' },
    mire25: { left: '50%', bottom: '-1mm', value: '25' },
    mire26: { left: '0%', bottom: '-1mm', value: '26' },
    mire27: { left: '50%', bottom: '-1mm', value: '27' },
    mire28: { left: '0%', bottom: '-1mm', value: '28' },
    mire29: { left: '50%', bottom: '-1mm', value: '29' },
    mire30: { left: '0%', bottom: '-1mm', value: '30' },
    mire31: { left: '50%', bottom: '-1mm', value: '31' },
    mire32: { left: '0%', bottom: '-1mm', value: '32' },
    mire33: { left: '50%', bottom: '-1mm', value: '33' },
    mire34: { left: '0%', bottom: '-1mm', value: '34' },
    mire35: { left: '50%', bottom: '-1mm', value: '35' },
    mire36: { left: '0%', bottom: '-1mm', value: '36' },
    mire37: { left: '50%', bottom: '-1mm', value: '37' },
    mire38: { left: '0%', bottom: '-1mm', value: '38' },
    mire39: { left: '50%', bottom: '-1mm', value: '39' }
  };

  function addChiffre(mireId, position) {
    const mire = document.getElementById(mireId);
    const chiffre = document.createElement('div');
    chiffre.className = 'chiffre';
    const mireNum = parseInt(mireId.replace('mire', ''));
    const groupNum = Math.floor(mireNum / 10);
    if (groupNum % 2 === 1) {
      chiffre.classList.add('red');
    }
    chiffre.style.left = position.left;
    chiffre.style.bottom = position.bottom;
    chiffre.textContent = position.value;
    mire.appendChild(chiffre);
  }

  // Ajouter les chiffres
  addChiffre('mire0', chiffresPositions.mire0);
  addChiffre('mire1', chiffresPositions.mire1);
  addChiffre('mire2', chiffresPositions.mire2);
  addChiffre('mire3', chiffresPositions.mire3);
  addChiffre('mire4', chiffresPositions.mire4);
  addChiffre('mire5', chiffresPositions.mire5);
  addChiffre('mire6', chiffresPositions.mire6);
  addChiffre('mire7', chiffresPositions.mire7);
  addChiffre('mire8', chiffresPositions.mire8);
  addChiffre('mire9', chiffresPositions.mire9);
  addChiffre('mire10', chiffresPositions.mire10);
  addChiffre('mire11', chiffresPositions.mire11);
  addChiffre('mire12', chiffresPositions.mire12);
  addChiffre('mire13', chiffresPositions.mire13);
  addChiffre('mire14', chiffresPositions.mire14);
  addChiffre('mire15', chiffresPositions.mire15);
  addChiffre('mire16', chiffresPositions.mire16);
  addChiffre('mire17', chiffresPositions.mire17);
  addChiffre('mire18', chiffresPositions.mire18);
  addChiffre('mire19', chiffresPositions.mire19);
  addChiffre('mire20', chiffresPositions.mire20);
  addChiffre('mire21', chiffresPositions.mire21);
  addChiffre('mire22', chiffresPositions.mire22);
  addChiffre('mire23', chiffresPositions.mire23);
  addChiffre('mire24', chiffresPositions.mire24);
  addChiffre('mire25', chiffresPositions.mire25);
  addChiffre('mire26', chiffresPositions.mire26);
  addChiffre('mire27', chiffresPositions.mire27);
  addChiffre('mire28', chiffresPositions.mire28);
  addChiffre('mire29', chiffresPositions.mire29);
  addChiffre('mire30', chiffresPositions.mire30);
  addChiffre('mire31', chiffresPositions.mire31);
  addChiffre('mire32', chiffresPositions.mire32);
  addChiffre('mire33', chiffresPositions.mire33);
  addChiffre('mire34', chiffresPositions.mire34);
  addChiffre('mire35', chiffresPositions.mire35);
  addChiffre('mire36', chiffresPositions.mire36);
  addChiffre('mire37', chiffresPositions.mire37);
  addChiffre('mire38', chiffresPositions.mire38);
  addChiffre('mire39', chiffresPositions.mire39);

  // Syst√®me de lecture avec graduation invisible
  const miresWrapper = document.getElementById('miresWrapper');
  const miresViewport = document.getElementById('miresViewport');
  const readingValue = document.getElementById('readingValue');
  const showReadingBtn = document.getElementById('showReadingBtn');
  const randomBtn = document.getElementById('randomBtn');

  function showReading() {
    readingValue.style.display = 'block';
    showReadingBtn.style.display = 'none';
  }

  function hideReading() {
    readingValue.style.display = 'none';
    showReadingBtn.style.display = 'block';
  }

  showReadingBtn.addEventListener('click', showReading);

  function setRandomPosition() {
    const totalHeight = getTotalHeight();
    const viewportHeight = miresViewport.clientHeight;
    
    // Plage de mouvement possible (comme dans mousemove)
    const minPos = -(totalHeight - viewportHeight / 2);
    const maxPos = viewportHeight / 2;
    
    // Position al√©atoire
    let randomPos = Math.random() * (maxPos - minPos) + minPos;
    
    // Snap to graduation
    randomPos = snapToGraduation(randomPos);
    
    // Appliquer
    miresWrapper.style.top = randomPos + 'px';
    wrapperStartPos = randomPos; // Mettre √† jour pour le prochain drag
    
    updateReadingValue();
    hideReading(); // Cacher la lecture pour l'exercice
  }

  randomBtn.addEventListener('click', setRandomPosition);

  // Initialiser avec une position al√©atoire
  window.addEventListener('load', setRandomPosition);

  let isDragging = false;
  let dragStart = 0;
  let wrapperStartPos = 0;

  // Constantes de conversion
  const MM_PER_CM = 10;
  const MIRE_HEIGHT_CM = 10;
  const MIRE_HEIGHT_MM = 100;
  const GRADUATION_MM = 1;
  const GRADUATION_CM = GRADUATION_MM / MM_PER_CM;
  const TOTAL_MIRES = 40;
  const TOTAL_MM = 4000;

  let currentZoom = 1;
  const MIN_ZOOM = 0.1;
  const MAX_ZOOM = 5.0;
  const ZOOM_STEP = 0.1;

  function zoom(direction) {
    const newZoom = currentZoom + (direction * ZOOM_STEP);
    if (newZoom >= MIN_ZOOM && newZoom <= MAX_ZOOM) {
      currentZoom = newZoom;
      applyZoom();
    }
  }

  function applyZoom() {
    // Appliquer le scale
    miresWrapper.style.transform = `scale(${currentZoom})`;
    miresWrapper.style.transformOrigin = 'left top';
    
    // Ajuster la largeur du viewport pour contenir le wrapper zoom√©
    // On utilise offsetWidth du wrapper qui donne la largeur "non zoom√©e" (layout width)
    // Multipli√©e par le zoom, cela donne la largeur visuelle requise.
    const baseWidth = miresWrapper.offsetWidth;
    const newViewportWidth = baseWidth * currentZoom;
    miresViewport.style.width = newViewportWidth + 'px';

    updateReadingValue();
  }

  // Recalculer au redimensionnement de la fen√™tre
  window.addEventListener('resize', () => {
    // Le clamp CSS peut changer la largeur de base du wrapper
    // Il faut r√©appliquer la largeur du viewport
    applyZoom();
    updateReadingValue();
  });

  function pxPerMM() {
    const testMire = document.getElementById('mire0');
    if (!testMire) return 3.78;
    const rect = testMire.getBoundingClientRect();
    // Le getBoundingClientRect prend en compte le scale (zoom)
    const height = rect.height;
    return height / MIRE_HEIGHT_MM;
  }

  function updateReadingValue() {
    const pixelsPerMM = pxPerMM();
    
    // Position actuelle du wrapper (top CSS)
    const wrapperTop = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    
    // Hauteur visible du viewport
    const viewportHeight = miresViewport.clientHeight;
    
    // Hauteur totale "r√©elle" (non zoom√©e) du contenu
    const rawTotalHeight = miresWrapper.scrollHeight;
    
    // Hauteur totale effective (zoom√©e)
    // Note: scrollHeight ne change pas avec transform: scale(), 
    // mais visuellement l'√©l√©ment est plus grand/petit.
    // Cependant, pxPerMM() utilise getBoundingClientRect() qui LUI prend en compte le zoom.
    
    // Le point de lecture est au centre du viewport
    const readingPointY = viewportHeight / 2;
    
    // La position du haut du wrapper par rapport au viewport est wrapperTop.
    // Mais attention, avec transform: scale(), le rendu visuel est d√©cal√©.
    // Si transform-origin est 'center top', le haut reste align√© avec wrapperTop (verticalement).
    // Donc la distance entre le haut du wrapper et la ligne de lecture est :
    const distancePixels = readingPointY - wrapperTop;
    
    // Cette distance est en pixels "√©cran".
    // Comme pxPerMM() retourne des pixels "√©cran" par mm (gr√¢ce √† getBoundingClientRect),
    // la division devrait donner la bonne valeur en mm.
    
    // Il faut juste s'assurer que wrapperTop est bien appliqu√© sur l'√©l√©ment non transform√©
    // ou que la logique de d√©placement prend en compte le zoom si n√©cessaire.
    // Dans notre cas, on d√©place le wrapper avec top (pixels non zoom√©s) ?
    // NON. Si on utilise top en pixels, et qu'on a un scale, 
    // 1px de top d√©place l'√©l√©ment de 1px *visuel* si le parent n'est pas zoom√©.
    // MAIS le contenu √† l'int√©rieur est zoom√©.
    
    // Correction : Si on zoome le wrapper, sa hauteur visuelle change.
    // pxPerMM() nous donne l'√©chelle visuelle actuelle.
    
    // Probl√®me : Quand on zoome, le point "0" (bas de la mire) bouge visuellement si on ne compense pas.
    // Pour l'instant, essayons simplement avec la logique existante car pxPerMM est dynamique.
    
    // Il faut inverser la logique : on lit la distance depuis le BAS du wrapper.
    // Total height visuelle = rawTotalHeight * currentZoom
    const visualTotalHeight = rawTotalHeight * currentZoom;
    
    // Position du haut du wrapper (visuel) = wrapperTop
    // (Si transform-origin est top, le top ne bouge pas)
    
    // Distance du point de lecture par rapport au haut visuel
    const distFromTop = readingPointY - wrapperTop;
    
    // Distance du point de lecture par rapport au BAS visuel
    const distFromBottom = visualTotalHeight - distFromTop;
    
    // Conversion en mm
    const readingMM = Math.round(distFromBottom / pixelsPerMM);
    
    // Note: pxPerMM() = (rawHeight * zoom) / 100
    // Donc readingMM = distFromBottom / ((rawHeight * zoom) / 100)
    
    // Simplifions :
    // readingMM = (visualTotalHeight - (readingPointY - wrapperTop)) / pxPerMM
    
    // Testons si l'ancienne formule marche encore :
    // const readingMM = Math.round((totalHeight - readingPosPixels) / pixelsPerMM);
    // totalHeight ici √©tait scrollHeight (non zoom√©).
    // Si on remplace par visualTotalHeight, √ßa devrait marcher.
    
    const readingMM_v2 = Math.round((visualTotalHeight - (readingPointY - wrapperTop)) / pixelsPerMM);
    
    const clampedMM = Math.max(0, Math.min(TOTAL_MM, readingMM_v2));
    const roundedMM = roundToSpecial(clampedMM);
    readingValue.textContent = roundedMM + ' mm';
  }

  function roundToSpecial(val) {
    const tens = Math.floor(val / 10) * 10;
    const unit = val % 10;
    let suffix = 0;
    
    if (unit <= 1) suffix = 0;
    else if (unit <= 3) suffix = 2;
    else if (unit <= 6) suffix = 5;
    else if (unit <= 8) suffix = 7;
    else suffix = 10;
    
    return tens + suffix;
  }

  function getTotalHeight() {
    // Retourne la hauteur VISUELLE totale
    return miresWrapper.scrollHeight * currentZoom;
  }

  function snapToGraduation(pos) {
    const pixelsPerMM = pxPerMM();
    const snapSizePixels = GRADUATION_MM * pixelsPerMM;
    return Math.round(pos / snapSizePixels) * snapSizePixels;
  }

  miresWrapper.addEventListener('mousedown', (e) => {
    isDragging = true;
    dragStart = e.clientY;
    wrapperStartPos = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    miresWrapper.classList.add('dragging');
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    hideReading();

    const deltaY = e.clientY - dragStart;
    let newPos = wrapperStartPos + deltaY;

    const totalHeight = getTotalHeight();
    const viewportHeight = miresViewport.clientHeight;
    const minPos = -(totalHeight - viewportHeight / 2);
    const maxPos = viewportHeight / 2;

    newPos = Math.max(minPos, Math.min(maxPos, newPos));
    newPos = snapToGraduation(newPos);

    miresWrapper.style.top = newPos + 'px';
    updateReadingValue();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    miresWrapper.classList.remove('dragging');
  });

// ----------------------------------------
// üéØ Scrolling par molette (DESKTOP uniquement)
// ----------------------------------------
if (!('ontouchstart' in window)) {
  miresViewport.addEventListener('wheel', (e) => {
    e.preventDefault();

    const pixelsPerMM = pxPerMM();
    const stepMM = 70; // 7 cm = 70 mm
    const direction = e.deltaY > 0 ? -1 : 1;
    const step = direction * pixelsPerMM * stepMM; // conversion mm ‚Üí pixels

    let currentTop = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    let newPos = currentTop + step;

    const totalHeight = getTotalHeight();
    const viewportHeight = miresViewport.clientHeight;

    const minPos = -(totalHeight - viewportHeight / 2);
    const maxPos = viewportHeight / 2;

    newPos = Math.max(minPos, Math.min(maxPos, newPos));
    newPos = snapToGraduation(newPos);

    miresWrapper.style.top = newPos + 'px';
    updateReadingValue();
  }, { passive: false });
}


// ----------------------------------------
// üéØ GESTION DU TOUCH (mobile & tablette)
// ----------------------------------------
let touchStartY = 0;

miresViewport.addEventListener('touchstart', (e) => {
  isDragging = true;
  touchStartY = e.touches[0].clientY;
  wrapperStartPos = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
  miresWrapper.classList.add('dragging');
}, { passive: false }); // <-- passive false ici

miresViewport.addEventListener('touchmove', (e) => {
  if (!isDragging) return;

  e.preventDefault(); // <-- emp√™che le scroll par d√©faut

  const deltaY = e.touches[0].clientY - touchStartY;
  let newPos = wrapperStartPos + deltaY;

  const totalHeight = getTotalHeight();
  const viewportHeight = miresViewport.clientHeight;
  const minPos = -(totalHeight - viewportHeight / 2);
  const maxPos = viewportHeight / 2;

  newPos = Math.max(minPos, Math.min(maxPos, newPos));
  newPos = snapToGraduation(newPos);

  miresWrapper.style.top = newPos + 'px';
  updateReadingValue();
}, { passive: false }); // <-- passive false ici

miresViewport.addEventListener('touchend', () => {
  isDragging = false;
  miresWrapper.classList.remove('dragging');
});


  // Position initiale (mire0 au milieu du viewport pour lire 0 mm)
  window.onload = () => {
  const viewportHeight = miresViewport.clientHeight;
  const totalHeight = getTotalHeight();
  const initialTop = (viewportHeight / 2) - totalHeight;
  miresWrapper.style.top = initialTop + 'px';
  updateReadingValue();
};
</script>

</body>
</html>