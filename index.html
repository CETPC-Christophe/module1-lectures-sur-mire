<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Mires Verticales avec Chiffres Positionnables</title>
<style>
  :root {
    --zoom-level: 1;
    --right-digit-offset: 5%;
    --right-digit-offset-px: 8px;
  }

  /* Responsive: plus d'espace sur mobile, un peu moins sur grands √©crans */
  @media (max-width: 640px), (pointer: coarse) {
    :root { --right-digit-offset: 6%; }
  }
  @media (min-width: 1280px) {
    :root { --right-digit-offset: 4%; }
  }

  html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    background-color: #f0f0f0;
  }

  body {
    display: flex;
    align-items: center;
    justify-content: center;
    height: 100%;
    margin: 0;
    padding: 0;
  }

  .main-layout {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: clamp(1.5cm, 6vw, 3.5cm);
    width: 100%;
    height: 100%;
    box-sizing: border-box;
    padding: clamp(0.5cm, 3vw, 1.5cm);
  }

  .container {
    display: flex;
    gap: clamp(0.3cm, 1.5vw, 0.9cm);
    height: 100%;
    align-items: center;
    padding: clamp(0.5cm, 2vw, 1cm);
    position: relative; /* pour positionner le r√©ticule en overlay */
  }

  .mires-viewport {
    width: calc(clamp(0.9cm, 6vw, 1.8cm) * var(--zoom-level));
    height: 100%;
    overflow: hidden;
    position: relative;
    border: 2px solid #333;
    background-color: white;
    padding: 0 0.5cm; /* marge blanche r√©duite (0,5 cm de chaque c√¥t√©) */
  }

  .mires-wrapper {
    display: flex;
    flex-direction: column;
    position: absolute;
    left: 50%;
    transform: translateX(-50%);
    gap: 0;
    cursor: grab;
    user-select: none;
  }

  .mires-wrapper.dragging {
    cursor: grabbing;
  }

  .mire {
    display: flex;
    flex-direction: column-reverse;
    position: relative;
    gap: 0;
  }

  .line-container {
    display: flex;
    width: calc(clamp(0.9cm, 6vw, 1.8cm) * var(--zoom-level));
    height: calc(clamp(0.2cm, 1.5vw, 0.45cm) * var(--zoom-level));
  }

  .line-container.first-line {
    border-bottom: 2px solid black;
  }

  /* Trait horizontal rouge pour les mires rouges */
  .mire.red-group .line-container.first-line {
    border-bottom: 2px solid red;
  }

  .square {
    flex: 1;
    height: calc(clamp(0.2cm, 1.5vw, 0.45cm) * var(--zoom-level));
  }

  .red { background-color: red; }
  .black { background-color: black; }
  .white { background-color: white; }

  .trait-noir {
    display: none;
  }

  .chiffre {
    position: absolute;
    font-size: calc(clamp(0.2cm, 1vw, 0.4cm) * var(--zoom-level));
    font-weight: bold;
    color: black;
    transform: scaleX(2) scaleY(8);
    transform-origin: left bottom;
  }

  .chiffre.red {
    color: red;
    background-color: transparent;
    padding: 0;
    border-radius: 0;
  }

  .reticule {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    pointer-events: none;
    z-index: 5;
    width: clamp(6cm, 50vw, 12cm);
    height: auto;
  }

  .reading-value {
    position: fixed;
    left: clamp(1cm, 7vw, 2cm);
    top: 50%;
    transform: translateY(-50%);
    font-size: clamp(11px, 2.5vw, 22px);
    font-weight: bold;
    color: black;
    z-index: 100;
    min-width: 150px;
    text-align: left;
  }
  /* Bloc multi-lectures (haut/milieu/bas) */
  .reading-values {
    position: fixed;
    right: 20px;
    bottom: 20px;
    left: auto;
    top: auto;
    transform: none;
    z-index: 100;
    background: rgba(255,255,255,0.9);
    border: 2px solid #333;
    border-radius: 10px;
    padding: 10px 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    min-width: 220px;
    font-size: clamp(11px, 2.2vw, 20px);
    display: none; /* cach√© sur demande */
  }
  .reading-item { display: flex; justify-content: space-between; margin: 4px 0; }
  .reading-label { color: #444; font-weight: 600; }
  .reading-mm { color: #000; font-weight: 700; }

  .zoom-controls {
    position: fixed;
    bottom: 20px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 10px;
    z-index: 101;
  }

  .zoom-btn {
    width: 50px;
    height: 50px;
    border: 2px solid #333;
    background-color: white;
    border-radius: 50%;
    font-size: 24px;
    font-weight: bold;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  .zoom-btn:hover {
    background-color: #f0f0f0;
    transform: scale(1.1);
  }

  .zoom-btn:active {
    transform: scale(0.95);
  }

  .zoom-level {
    display: flex;
    align-items: center;
    padding: 0 15px;
    background-color: white;
    border: 2px solid #333;
    border-radius: 25px;
    font-weight: bold;
    font-size: 16px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.2);
  }

  /* Panneau d'exercice */
  .exercise-panel {
    position: fixed;
    right: clamp(0.5cm, 2vw, 1cm);
    top: 50%;
    transform: translateY(-50%);
    width: clamp(220px, 25vw, 320px);
    max-width: calc(100vw - 12cm);
    z-index: 10;
    background-color: white;
    border: 3px solid #333;
    border-radius: 15px;
    padding: clamp(12px, 2vw, 20px);
    box-shadow: 0 4px 10px rgba(0,0,0,0.3);
  }

  @media (max-width: 1024px) {
    .exercise-panel {
      width: clamp(200px, 30vw, 280px);
      right: clamp(0.4cm, 1.5vw, 0.8cm);
    }
  }

  @media (max-width: 768px) {
    .exercise-panel {
      width: clamp(180px, 35vw, 240px);
      right: clamp(0.3cm, 1vw, 0.5cm);
      padding: clamp(8px, 1.5vw, 15px);
    }
  }

  @media (max-width: 480px) {
    .exercise-panel {
      width: clamp(160px, 40vw, 200px);
      right: 0.3cm;
      padding: 10px;
    }
  }

  .exercise-title {
    font-size: clamp(16px, 2vw, 20px);
    font-weight: bold;
    text-align: center;
    margin-bottom: clamp(10px, 1.5vw, 15px);
    color: #333;
    border-bottom: 2px solid #333;
    padding-bottom: clamp(8px, 1vw, 10px);
  }

  .question-number {
    font-size: clamp(14px, 1.5vw, 16px);
    font-weight: bold;
    margin-bottom: clamp(8px, 1vw, 10px);
    color: #666;
  }

  .instruction {
    font-size: clamp(12px, 1.3vw, 14px);
    margin-bottom: clamp(10px, 1.5vw, 15px);
    color: #444;
    line-height: 1.4;
  }

  .input-group {
    margin-bottom: 15px;
  }

  .input-group label {
    display: block;
    font-size: 14px;
    font-weight: bold;
    margin-bottom: 5px;
    color: #333;
  }

  .input-group input {
    width: 100%;
    padding: clamp(8px, 1vw, 10px);
    font-size: clamp(14px, 1.5vw, 16px);
    border: 2px solid #333;
    border-radius: 5px;
    box-sizing: border-box;
  }

  .exercise-btn {
    width: 100%;
    padding: clamp(10px, 1.2vw, 12px);
    font-size: clamp(14px, 1.5vw, 16px);
    font-weight: bold;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    transition: all 0.3s;
    margin-bottom: clamp(8px, 1vw, 10px);
  }

  .btn-verify {
    background-color: #4CAF50;
    color: white;
  }

  .btn-verify:hover {
    background-color: #45a049;
    transform: scale(1.02);
  }

  .btn-next {
    background-color: #2196F3;
    color: white;
    display: none;
  }

  .btn-next:hover {
    background-color: #0b7dda;
    transform: scale(1.02);
  }

  .btn-restart {
    background-color: #ff9800;
    color: white;
    display: none;
  }

  .btn-restart:hover {
    background-color: #e68900;
    transform: scale(1.02);
  }

  .feedback {
    padding: 10px;
    border-radius: 5px;
    margin-bottom: 10px;
    font-weight: bold;
    text-align: center;
    display: none;
  }

  .feedback.correct {
    background-color: #d4edda;
    color: #155724;
    border: 2px solid #c3e6cb;
  }

  .feedback.incorrect {
    background-color: #f8d7da;
    color: #721c24;
    border: 2px solid #f5c6cb;
  }

  .score-display {
    text-align: center;
    font-size: clamp(16px, 1.8vw, 18px);
    font-weight: bold;
    margin-top: clamp(8px, 1vw, 10px);
    padding: clamp(8px, 1vw, 10px);
    background-color: #f0f0f0;
    border-radius: 8px;
  }

  .final-score {
    display: none;
    text-align: center;
    padding: 20px;
  }

  .final-score h2 {
    color: #333;
    margin-bottom: 15px;
  }

  .final-score .percentage {
    font-size: 36px;
    font-weight: bold;
    color: #4CAF50;
    margin: 15px 0;
  }
</style>
</head>
<body>

<div class="main-layout">
<div class="container">
  <div class="mires-viewport" id="miresViewport" role="slider" aria-label="R√®gle de mesure verticale" aria-valuemin="0" aria-valuemax="4000" aria-valuenow="0" tabindex="0">
    <div class="mires-wrapper" id="miresWrapper">
      <!-- mire39 (39) -->
<div class="mire" id="mire39">
  <div class="trait-noir"></div>
</div>

<!-- mire38 (38) -->
<div class="mire" id="mire38">
  <div class="trait-noir"></div>
</div>

<!-- mire37 (37) -->
<div class="mire" id="mire37">
  <div class="trait-noir"></div>
</div>

<!-- mire36 (36) -->
<div class="mire" id="mire36">
  <div class="trait-noir"></div>
</div>

<!-- mire35 (35) -->
<div class="mire" id="mire35">
  <div class="trait-noir"></div>
</div>

<!-- mire34 (34) -->
<div class="mire" id="mire34">
  <div class="trait-noir"></div>
</div>

<!-- mire33 (33) -->
<div class="mire" id="mire33">
  <div class="trait-noir"></div>
</div>

<!-- mire32 (32) -->
<div class="mire" id="mire32">
  <div class="trait-noir"></div>
</div>

<!-- mire31 (31) -->
<div class="mire" id="mire31">
  <div class="trait-noir"></div>
</div>

<!-- mire30 (30) -->
<div class="mire" id="mire30">
  <div class="trait-noir"></div>
</div>

<!-- mire29 (29) -->
<div class="mire" id="mire29">
  <div class="trait-noir"></div>
</div>

<!-- mire28 (28) -->
<div class="mire" id="mire28">
  <div class="trait-noir"></div>
</div>

<!-- mire27 (27) -->
<div class="mire" id="mire27">
  <div class="trait-noir"></div>
</div>

<!-- mire26 (26) -->
<div class="mire" id="mire26">
  <div class="trait-noir"></div>
</div>

<!-- mire25 (25) -->
<div class="mire" id="mire25">
  <div class="trait-noir"></div>
</div>

<!-- mire24 (24) -->
<div class="mire" id="mire24">
  <div class="trait-noir"></div>
</div>

<!-- mire23 (23) -->
<div class="mire" id="mire23">
  <div class="trait-noir"></div>
</div>

<!-- mire22 (22) -->
<div class="mire" id="mire22">
  <div class="trait-noir"></div>
</div>

<!-- mire21 (21) -->
<div class="mire" id="mire21">
  <div class="trait-noir"></div>
</div>

<!-- mire20 (20) -->
<div class="mire" id="mire20">
  <div class="trait-noir"></div>
</div>

<!-- mire19 (19) -->
<div class="mire" id="mire19">
  <div class="trait-noir"></div>
</div>

<!-- mire18 (18) -->
<div class="mire" id="mire18">
  <div class="trait-noir"></div>
</div>

<!-- mire17 (17) -->
<div class="mire" id="mire17">
  <div class="trait-noir"></div>
</div>

<!-- mire16 (16) -->
<div class="mire" id="mire16">
  <div class="trait-noir"></div>
</div>

<!-- mire15 (15) -->
<div class="mire" id="mire15">
  <div class="trait-noir"></div>
</div>

<!-- mire14 (14) -->
<div class="mire" id="mire14">
  <div class="trait-noir"></div>
</div>

<!-- mire13 (13) -->
<div class="mire" id="mire13">
  <div class="trait-noir"></div>
</div>

<!-- mire12 (12) -->
<div class="mire" id="mire12">
  <div class="trait-noir"></div>
</div>

<!-- mire11 (11) -->
<div class="mire" id="mire11">
  <div class="trait-noir"></div>
</div>

<!-- mire10 (10) -->
<div class="mire" id="mire10">
  <div class="trait-noir"></div>
</div>

<!-- mire9 (9) -->
<div class="mire" id="mire9">
  <div class="trait-noir"></div>
</div>

<!-- mire8 (8) -->
<div class="mire" id="mire8">
  <div class="trait-noir"></div>
</div>

<!-- mire7 (7) -->
<div class="mire" id="mire7">
  <div class="trait-noir"></div>
</div>

<!-- mire6 (6) -->
<div class="mire" id="mire6">
  <div class="trait-noir"></div>
</div>

<!-- mire5 (5) -->
<div class="mire" id="mire5">
  <div class="trait-noir"></div>
</div>

<!-- mire4 (4) -->
<div class="mire" id="mire4">
  <div class="trait-noir"></div>
</div>

<!-- mire3 (3) -->
<div class="mire" id="mire3">
  <div class="trait-noir"></div>
</div>

<!-- mire2 (2) -->
<div class="mire" id="mire2">
  <div class="trait-noir"></div>
</div>

<!-- mire1 (1) -->
<div class="mire" id="mire1">
  <div class="trait-noir"></div>
</div>

<!-- mire0 (0) -->
<div class="mire" id="mire0">
  <div class="trait-noir"></div>
</div>
    </div>
  </div>
  <div class="reticule">
  <svg width="12cm" height="12cm" viewBox="0 0 1200 1200" xmlns="http://www.w3.org/2000/svg" aria-labelledby="title desc">
    <title id="title">R√©ticule de vis√©e</title>
    <desc id="desc">Deux segments perpendiculaires de 8 cm se coupant en leur milieu avec cercle de 8 cm de diam√®tre</desc>

    <!-- centre -->
    <circle cx="600" cy="600" r="6" fill="#333" />

    <!-- segments : longueur 8 cm -> 800 unit√©s (√©chelle 100 unit√©s = 1 cm) -->
    <!-- segment horizontal -->
    <line x1="200" y1="600" x2="1000" y2="600" stroke="#000" stroke-width="8" stroke-linecap="round" />
    <!-- segment vertical -->
    <line x1="600" y1="200" x2="600" y2="1000" stroke="#000" stroke-width="8" stroke-linecap="round" />

    <!-- petit segment horizontal √† 3 cm au-dessus de l'intersection (5 cm de long) -->
    <line x1="375" y1="350" x2="825" y2="350" stroke="#000" stroke-width="6" stroke-linecap="round" />

    <!-- segment sym√©trique sous l'intersection -->
    <line x1="375" y1="850" x2="825" y2="850" stroke="#000" stroke-width="6" stroke-linecap="round" />

    <!-- cercle de diam√®tre 8 cm -> rayon 4 cm -> 400 unit√©s -->
    <circle cx="600" cy="600" r="400" fill="none" stroke="#000" stroke-width="6" />
  </svg>
</div>

</div>

<!-- Panneau d'exercice -->
<div class="exercise-panel" id="exercisePanel">
  <div class="exercise-title">Exercice de Lecture</div>
  
  <div id="exerciseContent">
    <div class="question-number" id="questionNumber">Question 1/20</div>
    <div class="instruction" id="instructionText">Lisez la valeur affich√©e sur la mire et saisissez-la ci-dessous :</div>
    
    <div class="input-group">
      <label for="userAnswer">Votre r√©ponse (en mm) :</label>
      <input type="number" id="userAnswer" placeholder="Ex: 1234">
    </div>
    
    <div class="feedback" id="feedback"></div>
    
    <button class="exercise-btn btn-verify" id="btnVerify">V√©rifier</button>
    <button class="exercise-btn btn-next" id="btnNext">Question suivante</button>
    
    <div class="score-display" id="scoreDisplay">Score: 0/0</div>
  </div>
  
  <div class="final-score" id="finalScore">
    <h2>Exercice termin√© !</h2>
    <div class="percentage" id="finalPercentage">0%</div>
    <div id="finalMessage"></div>
    <button class="exercise-btn btn-restart" id="btnRestart">Recommencer</button>
  </div>
</div>

</div>

<div class="reading-values" id="readingValues">
  <div class="reading-item"><span class="reading-label">Fil stadim√©trique haut</span><span class="reading-mm" id="readingTop">0 mm</span></div>
  <div class="reading-item"><span class="reading-label">Fil niveleur (milieu)</span><span class="reading-mm" id="readingCenter">0 mm</span></div>
  <div class="reading-item"><span class="reading-label">Fil stadim√©trique bas</span><span class="reading-mm" id="readingBottom">0 mm</span></div>
  </div>

<div class="zoom-controls">
  <button class="zoom-btn" id="zoomOut" title="Zoom arri√®re" aria-label="R√©duire le zoom">‚àí</button>
  <div class="zoom-level" id="zoomLevel">100%</div>
  <button class="zoom-btn" id="zoomIn" title="Zoom avant" aria-label="Augmenter le zoom">+</button>
</div>

<script>
  // Couleurs des mires
  const mire1Colors = [
    ['white','white','white','white'],
    ['white','white','red','white'],
    ['white','white','white','white'],
    ['white','white','red','white'],
    ['white','white','white','white'],
    ['white','white','red','red'],
    ['white','white','white','red'],
    ['white','white','red','red'],
    ['white','white','white','red'],
    ['white','white','red','red']
  ];

  const mire2Colors = [
    ['white','white','white','white'],
    ['white','red','white','white'],
    ['white','white','white','white'],
    ['white','red','white','white'],
    ['white','white','white','white'],
    ['red','red','white','white'],
    ['red','white','white','white'],
    ['red','red','white','white'],
    ['red','white','white','white'],
    ['red','red','white','white']
  ];

  const mire1BlackColors = [
    ['white','white','white','white'],
    ['white','white','black','white'],
    ['white','white','white','white'],
    ['white','white','black','white'],
    ['white','white','white','white'],
    ['white','white','black','black'],
    ['white','white','white','black'],
    ['white','white','black','black'],
    ['white','white','white','black'],
    ['white','white','black','black']
  ];

  const mire2BlackColors = [
    ['white','white','white','white'],
    ['white','black','white','white'],
    ['white','white','white','white'],
    ['white','black','white','white'],
    ['white','white','white','white'],
    ['black','black','white','white'],
    ['black','white','white','white'],
    ['black','black','white','white'],
    ['black','white','white','white'],
    ['black','black','white','white']
  ];

  function generateMire(mireId, colors) {
    const mire = document.getElementById(mireId);
    colors.forEach((line, index) => {
      const lineDiv = document.createElement('div');
      lineDiv.className = 'line-container';
      if (index === 0) {
        lineDiv.classList.add('first-line');
      }
      line.forEach(color => {
        const square = document.createElement('div');
        square.className = `square ${color}`;
        lineDiv.appendChild(square);
      });
      mire.appendChild(lineDiv);
    });
  }

  // G√©n√©rer les mires avec une boucle optimis√©e
  for (let i = 0; i <= 39; i++) {
    let colors;
    // Mires 0-9 et 20-29 : noir/blanc
    // Mires 10-19 et 30-39 : rouge/blanc
    if ((i >= 0 && i <= 9) || (i >= 20 && i <= 29)) {
      colors = (i % 2 === 0) ? mire1BlackColors : mire2BlackColors;
    } else {
      colors = (i % 2 === 0) ? mire1Colors : mire2Colors;
    }
    generateMire(`mire${i}`, colors);
    const mireEl = document.getElementById(`mire${i}`);
    const isRedGroup = (i >= 10 && i <= 19) || (i >= 30 && i <= 39);
    if (isRedGroup && mireEl) {
      mireEl.classList.add('red-group');
    }
  }

  // Positions personnalis√©es des chiffres pour chaque mire
  const chiffresPositions = {
    mire0: { left: '0%', bottom: '0cm', value: '00' },
    mire1: { left: '50%', bottom: '-1mm', value: '01' },
    mire2: { left: '0%', bottom: '-1mm', value: '02' },
    mire3: { left: '50%', bottom: '-1mm', value: '03' },
    mire4: { left: '0%', bottom: '-1mm', value: '04' },
    mire5: { left: '50%', bottom: '-1mm', value: '05' },
    mire6: { left: '0%', bottom: '-1mm', value: '06' },
    mire7: { left: '50%', bottom: '-1mm', value: '07' },
    mire8: { left: '0%', bottom: '-1mm', value: '08' },
    mire9: { left: '50%', bottom: '-1mm', value: '09' },
    mire10: { left: '0%', bottom: '-1mm', value: '10' },
    mire11: { left: '50%', bottom: '-1mm', value: '11' },
    mire12: { left: '0%', bottom: '-1mm', value: '12' },
    mire13: { left: '50%', bottom: '-1mm', value: '13' },
    mire14: { left: '0%', bottom: '-1mm', value: '14' },
    mire15: { left: '50%', bottom: '-1mm', value: '15' },
    mire16: { left: '0%', bottom: '-1mm', value: '16' },
    mire17: { left: '50%', bottom: '-1mm', value: '17' },
    mire18: { left: '0%', bottom: '-1mm', value: '18' },
    mire19: { left: '50%', bottom: '-1mm', value: '19' },
    mire20: { left: '0%', bottom: '-1mm', value: '20' },
    mire21: { left: '50%', bottom: '-1mm', value: '21' },
    mire22: { left: '0%', bottom: '-1mm', value: '22' },
    mire23: { left: '50%', bottom: '-1mm', value: '23' },
    mire24: { left: '0%', bottom: '-1mm', value: '24' },
    mire25: { left: '50%', bottom: '-1mm', value: '25' },
    mire26: { left: '0%', bottom: '-1mm', value: '26' },
    mire27: { left: '50%', bottom: '-1mm', value: '27' },
    mire28: { left: '0%', bottom: '-1mm', value: '28' },
    mire29: { left: '50%', bottom: '-1mm', value: '29' },
    mire30: { left: '0%', bottom: '-1mm', value: '30' },
    mire31: { left: '50%', bottom: '-1mm', value: '31' },
    mire32: { left: '0%', bottom: '-1mm', value: '32' },
    mire33: { left: '50%', bottom: '-1mm', value: '33' },
    mire34: { left: '0%', bottom: '-1mm', value: '34' },
    mire35: { left: '50%', bottom: '-1mm', value: '35' },
    mire36: { left: '0%', bottom: '-1mm', value: '36' },
    mire37: { left: '50%', bottom: '-1mm', value: '37' },
    mire38: { left: '0%', bottom: '-1mm', value: '38' },
    mire39: { left: '50%', bottom: '-1mm', value: '39' }
  };

  function addChiffre(mireId, position) {
    const mire = document.getElementById(mireId);
    const chiffre = document.createElement('div');
    chiffre.className = 'chiffre';
    const mireNum = parseInt(mireId.replace('mire', ''));
    const groupNum = Math.floor(mireNum / 10);
    const isRedGroup = groupNum % 2 === 1;
    if (isRedGroup) {
      chiffre.classList.add('red');
    }
    const isRightColumn = position.left === '50%';
    chiffre.style.left = isRightColumn ? 'calc(50% + var(--right-digit-offset-px))' : position.left;
    chiffre.style.bottom = position.bottom;
    chiffre.textContent = position.value;
    mire.appendChild(chiffre);
  }

  // Ajouter les chiffres avec une boucle
  for (let i = 0; i <= 39; i++) {
    addChiffre(`mire${i}`, chiffresPositions[`mire${i}`]);
  }

  // Syst√®me de lecture avec graduation invisible
  const miresWrapper = document.getElementById('miresWrapper');
  const miresViewport = document.getElementById('miresViewport');
  const readingTop = document.getElementById('readingTop');
  const readingCenter = document.getElementById('readingCenter');
  const readingBottom = document.getElementById('readingBottom');
  const reticule = document.querySelector('.reticule');

  // Exercice
  const instructionText = document.getElementById('instructionText');

  let isDragging = false;
  let dragStart = 0;
  let wrapperStartPos = 0;

  // Constantes de conversion
  const MM_PER_CM = 10;
  const MIRE_HEIGHT_CM = 10;
  const MIRE_HEIGHT_MM = 100;
  const GRADUATION_MM = 1;
  const GRADUATION_CM = GRADUATION_MM / MM_PER_CM;
  const TOTAL_MIRES = 40;
  const TOTAL_MM = 4000;

  // Cache pour optimiser les performances
  let cachedPxPerMM = null;
  let zoomLevel = 1.0; // Niveau de zoom initial (100%)
  const MIN_ZOOM = 0.5; // 50%
  const MAX_ZOOM = 3.0; // 300%
  const ZOOM_STEP = 0.25; // Incr√©ment de 25%

  function pxPerMM() {
    if (cachedPxPerMM !== null) return cachedPxPerMM;
    const testMire = document.getElementById('mire0');
    if (!testMire) return 3.78;
    const rect = testMire.getBoundingClientRect();
    const height = rect.height;
    cachedPxPerMM = height / MIRE_HEIGHT_MM;
    return cachedPxPerMM;
  }

  // Offset en pixels pour les chiffres √† droite (distance exprim√©e en mm)
  const RIGHT_OFFSET_MM = 1.5; // 1,5 mm de marge √† droite

  function updateRightDigitOffsetPx() {
    const px = Math.max(2, Math.round(pxPerMM() * RIGHT_OFFSET_MM));
    document.documentElement.style.setProperty('--right-digit-offset-px', px + 'px');
  }

  // Recalculer le cache lors du redimensionnement
  window.addEventListener('resize', () => {
    cachedPxPerMM = null;
    updateRightDigitOffsetPx();
    updateReadingValue();
  });

  function getReadingValues() {
    const ppm = pxPerMM();
    const wrapperTop = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    const viewportHeight = miresViewport.clientHeight;
    const totalHeight = miresWrapper.scrollHeight;

    const rRect = reticule.getBoundingClientRect();
    const offsetTopPx = (350 - 600) / 1200 * rRect.height;   // n√©gatif
    const offsetCenterPx = 0;
    const offsetBottomPx = (850 - 600) / 1200 * rRect.height; // positif

    function computeMM(offsetPx) {
      const readingPosPixels = (viewportHeight / 2 + offsetPx) - wrapperTop;
      const mm = Math.round((totalHeight - readingPosPixels) / ppm);
      return Math.max(0, Math.min(TOTAL_MM, mm));
    }

    return {
      top: computeMM(offsetTopPx),
      center: computeMM(offsetCenterPx),
      bottom: computeMM(offsetBottomPx)
    };
  }

  function updateReadingValue() {
    const values = getReadingValues();
    readingTop.textContent = values.top + ' mm';
    readingCenter.textContent = values.center + ' mm';
    readingBottom.textContent = values.bottom + ' mm';
    miresViewport.setAttribute('aria-valuenow', values.center);
  }

  function getTotalHeight() {
    return miresWrapper.scrollHeight;
  }

  function snapToGraduation(pos) {
    const pixelsPerMM = pxPerMM();
    const snapSizePixels = GRADUATION_MM * pixelsPerMM;
    return Math.round(pos / snapSizePixels) * snapSizePixels;
  }

  miresWrapper.addEventListener('mousedown', (e) => {
    isDragging = true;
    dragStart = e.clientY;
    wrapperStartPos = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    miresWrapper.classList.add('dragging');
  });

  document.addEventListener('mousemove', (e) => {
    if (!isDragging) return;

    const deltaY = e.clientY - dragStart;
    let newPos = wrapperStartPos + deltaY;

    const totalHeight = getTotalHeight();
    const viewportHeight = miresViewport.clientHeight;
    const minPos = -(totalHeight - viewportHeight / 2);
    const maxPos = viewportHeight / 2;

    newPos = Math.max(minPos, Math.min(maxPos, newPos));
    newPos = snapToGraduation(newPos);

    miresWrapper.style.top = newPos + 'px';
    updateReadingValue();
  });

  document.addEventListener('mouseup', () => {
    isDragging = false;
    miresWrapper.classList.remove('dragging');
  });

// ----------------------------------------
// üéØ Scrolling par molette (DESKTOP uniquement)
// ----------------------------------------
if (!('ontouchstart' in window)) {
  miresViewport.addEventListener('wheel', (e) => {
    e.preventDefault();

    const pixelsPerMM = pxPerMM();
    const stepMM = 70; // 7 cm = 70 mm
    const direction = e.deltaY > 0 ? -1 : 1;
    const step = direction * pixelsPerMM * stepMM; // conversion mm ‚Üí pixels

    let currentTop = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
    let newPos = currentTop + step;

    const totalHeight = getTotalHeight();
    const viewportHeight = miresViewport.clientHeight;

    const minPos = -(totalHeight - viewportHeight / 2);
    const maxPos = viewportHeight / 2;

    newPos = Math.max(minPos, Math.min(maxPos, newPos));
    newPos = snapToGraduation(newPos);

    miresWrapper.style.top = newPos + 'px';
    updateReadingValue();
  }, { passive: false });
}


// ----------------------------------------
// üéØ GESTION DU TOUCH (mobile & tablette)
// ----------------------------------------
let touchStartY = 0;

miresViewport.addEventListener('touchstart', (e) => {
  isDragging = true;
  touchStartY = e.touches[0].clientY;
  wrapperStartPos = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
  miresWrapper.classList.add('dragging');
}, { passive: false }); // <-- passive false ici

miresViewport.addEventListener('touchmove', (e) => {
  if (!isDragging) return;

  e.preventDefault(); // <-- emp√™che le scroll par d√©faut

  const deltaY = e.touches[0].clientY - touchStartY;
  let newPos = wrapperStartPos + deltaY;

  const totalHeight = getTotalHeight();
  const viewportHeight = miresViewport.clientHeight;
  const minPos = -(totalHeight - viewportHeight / 2);
  const maxPos = viewportHeight / 2;

  newPos = Math.max(minPos, Math.min(maxPos, newPos));
  newPos = snapToGraduation(newPos);

  miresWrapper.style.top = newPos + 'px';
  updateReadingValue();
}, { passive: false }); // <-- passive false ici

miresViewport.addEventListener('touchend', () => {
  isDragging = false;
  miresWrapper.classList.remove('dragging');
});

// ----------------------------------------
// üéØ NAVIGATION CLAVIER (Accessibilit√©)
// ----------------------------------------
miresViewport.addEventListener('keydown', (e) => {
  if (e.key !== 'ArrowUp' && e.key !== 'ArrowDown') return;
  
  e.preventDefault();
  
  const pixelsPerMM = pxPerMM();
  // Ctrl = 1mm (pr√©cision), Shift = 100mm, Normal = 10mm
  let stepMM;
  if (e.ctrlKey) {
    stepMM = 1; // D√©placement pr√©cis au millim√®tre
  } else if (e.shiftKey) {
    stepMM = 100; // D√©placement rapide (10 cm)
  } else {
    stepMM = 10; // D√©placement standard (1 cm)
  }
  const direction = e.key === 'ArrowUp' ? 1 : -1;
  const step = direction * pixelsPerMM * stepMM;
  
  let currentTop = miresWrapper.style.top ? parseFloat(miresWrapper.style.top) : 0;
  let newPos = currentTop + step;
  
  const totalHeight = getTotalHeight();
  const viewportHeight = miresViewport.clientHeight;
  const minPos = -(totalHeight - viewportHeight / 2);
  const maxPos = viewportHeight / 2;
  
  newPos = Math.max(minPos, Math.min(maxPos, newPos));
  newPos = snapToGraduation(newPos);
  
  miresWrapper.style.top = newPos + 'px';
  updateReadingValue();
});

// ----------------------------------------
// üîç CONTR√îLES DE ZOOM
// ----------------------------------------
const zoomInBtn = document.getElementById('zoomIn');
const zoomOutBtn = document.getElementById('zoomOut');
const zoomLevelDisplay = document.getElementById('zoomLevel');

function applyZoom() {
  document.documentElement.style.setProperty('--zoom-level', zoomLevel);
  zoomLevelDisplay.textContent = Math.round(zoomLevel * 100) + '%';
  cachedPxPerMM = null; // Invalider le cache
  
  // Attendre que le DOM soit mis √† jour
  setTimeout(() => {
    updateRightDigitOffsetPx();
    updateReadingValue();
  }, 50);
}

zoomInBtn.addEventListener('click', () => {
  if (zoomLevel < MAX_ZOOM) {
    zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
    applyZoom();
  }
});

zoomOutBtn.addEventListener('click', () => {
  if (zoomLevel > MIN_ZOOM) {
    zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
    applyZoom();
  }
});

// Zoom avec Ctrl + molette (bonus)
if (!('ontouchstart' in window)) {
  document.addEventListener('wheel', (e) => {
    if (e.ctrlKey) {
      e.preventDefault();
      if (e.deltaY < 0 && zoomLevel < MAX_ZOOM) {
        zoomLevel = Math.min(MAX_ZOOM, zoomLevel + ZOOM_STEP);
        applyZoom();
      } else if (e.deltaY > 0 && zoomLevel > MIN_ZOOM) {
        zoomLevel = Math.max(MIN_ZOOM, zoomLevel - ZOOM_STEP);
        applyZoom();
      }
    }
  }, { passive: false });
}


  // Position initiale (mire0 au milieu du viewport pour lire 0 mm)
  window.onload = () => {
  updateRightDigitOffsetPx();
  const viewportHeight = miresViewport.clientHeight;
  const totalHeight = getTotalHeight();
  const initialTop = (viewportHeight / 2) - totalHeight;
  miresWrapper.style.top = initialTop + 'px';
  updateReadingValue();
  // Activer le focus pour permettre la navigation au clavier d√®s l'ouverture
  miresViewport.focus();
  
  // Initialiser l'exercice
  initExercise();
};

// ----------------------------------------
// üéì SYST√àME D'EXERCICE
// ----------------------------------------
let currentQuestion = 0;
let score = 0;
let questions = [];
const TOTAL_QUESTIONS = 20;
const TOLERANCE_MM = 2;

const READING_TYPES = ['top', 'center', 'bottom'];
const READING_LABELS = {
  top: 'Lecture fil stadim√©trique haut',
  center: 'Lecture fil niveleur (milieu)',
  bottom: 'Lecture fil stadim√©trique bas'
};

// G√©n√©rer 20 positions al√©atoires dans toute la plage (0-4000 mm)
function generateQuestions() {
  questions = [];
  const usedValues = new Set();

  // R√©partition demand√©e : 6 haut, 8 milieu, 6 bas
  const readingPlan = [
    ...Array(6).fill('top'),
    ...Array(8).fill('center'),
    ...Array(6).fill('bottom')
  ];

  // Shuffle du plan (Fisher‚ÄìYates)
  for (let i = readingPlan.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [readingPlan[i], readingPlan[j]] = [readingPlan[j], readingPlan[i]];
  }

  readingPlan.forEach((readingType) => {
    let value;
    do {
      value = Math.floor(Math.random() * 3900) + 50; // 50..3949
    } while (usedValues.has(value));

    usedValues.add(value);
    questions.push({
      targetValue: value,
      readingType,
      answered: false,
      correct: null,
      userAnswer: null
    });
  });
}

// Positionner la mire √† une valeur sp√©cifique
function setMirePosition(targetMM) {
  const pixelsPerMM = pxPerMM();
  const viewportHeight = miresViewport.clientHeight;
  const totalHeight = getTotalHeight();
  
  // Calculer la position du wrapper pour afficher targetMM au r√©ticule
  const readingPosPixels = totalHeight - (targetMM * pixelsPerMM);
  const newTop = (viewportHeight / 2) - readingPosPixels;
  
  miresWrapper.style.top = newTop + 'px';
  updateReadingValue();
}

// Obtenir la valeur actuelle affich√©e
function getCurrentMireValue() {
  const text = readingValue.textContent;
  return parseInt(text.replace(' mm', ''));
}

// Initialiser l'exercice
function initExercise() {
  generateQuestions();
  currentQuestion = 0;
  score = 0;
  showQuestion();
}

// Afficher une question
function showQuestion() {
  if (currentQuestion >= TOTAL_QUESTIONS) {
    showFinalScore();
    return;
  }
  
  const question = questions[currentQuestion];
  
  // Positionner la mire
  setMirePosition(question.targetValue);
  
  // Mise √† jour de l'interface
  document.getElementById('questionNumber').textContent = `Question ${currentQuestion + 1}/${TOTAL_QUESTIONS}`;
  instructionText.textContent = `Lisez : ${READING_LABELS[question.readingType]}`;
  document.getElementById('userAnswer').value = '';
  document.getElementById('feedback').style.display = 'none';
  document.getElementById('btnVerify').style.display = 'block';
  document.getElementById('btnNext').style.display = 'none';
  document.getElementById('userAnswer').disabled = false;
  document.getElementById('userAnswer').focus();
  
  updateScoreDisplay();
}

// V√©rifier la r√©ponse
function verifyAnswer() {
  const userInput = document.getElementById('userAnswer').value;
  
  if (userInput === '' || isNaN(userInput)) {
    alert('Veuillez saisir une valeur num√©rique.');
    return;
  }
  
  const userAnswer = parseInt(userInput);
  const question = questions[currentQuestion];
  const readings = getReadingValues();
  const expected = readings[question.readingType];
  const difference = Math.abs(userAnswer - expected);
  const isCorrect = difference <= TOLERANCE_MM;
  
  question.answered = true;
  question.correct = isCorrect;
  question.userAnswer = userAnswer;
  
  if (isCorrect) {
    score++;
  }
  
  // Afficher le feedback
  const feedback = document.getElementById('feedback');
  feedback.style.display = 'block';
  
  if (isCorrect) {
    feedback.className = 'feedback correct';
    feedback.textContent = `‚úì Correct ! ${READING_LABELS[question.readingType]} : ${expected} mm.`;
  } else {
    feedback.className = 'feedback incorrect';
    feedback.textContent = `‚úó Incorrect. ${READING_LABELS[question.readingType]} : ${expected} mm. (Votre r√©ponse: ${userAnswer} mm, √©cart: ${difference} mm)`;
  }
  
  // D√©sactiver le champ et changer les boutons
  document.getElementById('userAnswer').disabled = true;
  document.getElementById('btnVerify').style.display = 'none';
  document.getElementById('btnNext').style.display = 'block';
  
  updateScoreDisplay();
}

// Question suivante
function nextQuestion() {
  currentQuestion++;
  showQuestion();
}

// Afficher le score
function updateScoreDisplay() {
  const answered = questions.filter(q => q.answered).length;
  document.getElementById('scoreDisplay').textContent = `Score: ${score}/${answered}`;
}

// Afficher le score final
function showFinalScore() {
  document.getElementById('exerciseContent').style.display = 'none';
  document.getElementById('finalScore').style.display = 'block';
  document.getElementById('btnRestart').style.display = 'block';
  
  const percentage = Math.round((score / TOTAL_QUESTIONS) * 100);
  document.getElementById('finalPercentage').textContent = `${percentage}%`;
  
  let message = '';
  if (percentage >= 90) {
    message = 'üèÜ Excellent ! Vous ma√Ætrisez parfaitement la lecture des mires !';
    document.getElementById('finalPercentage').style.color = '#4CAF50';
  } else if (percentage >= 70) {
    message = 'üëç Tr√®s bien ! Continuez √† vous entra√Æner pour atteindre l\'excellence.';
    document.getElementById('finalPercentage').style.color = '#2196F3';
  } else if (percentage >= 50) {
    message = 'üìö Bien ! Avec un peu plus de pratique, vous allez progresser.';
    document.getElementById('finalPercentage').style.color = '#ff9800';
  } else {
    message = 'üí™ Continuez √† vous entra√Æner, la pratique est la cl√© du succ√®s !';
    document.getElementById('finalPercentage').style.color = '#f44336';
  }
  
  document.getElementById('finalMessage').textContent = message;
  document.getElementById('finalMessage').style.fontSize = '14px';
  document.getElementById('finalMessage').style.marginTop = '15px';
}

// Recommencer l'exercice
function restartExercise() {
  document.getElementById('exerciseContent').style.display = 'block';
  document.getElementById('finalScore').style.display = 'none';
  initExercise();
}

// √âv√©nements
document.getElementById('btnVerify').addEventListener('click', verifyAnswer);
document.getElementById('btnNext').addEventListener('click', nextQuestion);
document.getElementById('btnRestart').addEventListener('click', restartExercise);

// Permettre de valider avec la touche Entr√©e
document.getElementById('userAnswer').addEventListener('keypress', (e) => {
  if (e.key === 'Enter') {
    if (document.getElementById('btnVerify').style.display !== 'none') {
      verifyAnswer();
    } else {
      nextQuestion();
    }
  }
});
</script>

</body>
</html>